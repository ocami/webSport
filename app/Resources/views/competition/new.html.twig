{# TO DO
JS
 *locationFlush()
#}

{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.0/css/bootstrap-datepicker.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>

    <link rel="stylesheet" href="{{ asset('css/typeaheadjs.css') }}"/>
    <link rel="stylesheet" href="{{ asset('css/jquery-ui.css') }}"/>

    <style>
        #mapid {
            height: 180px;
        }

        .to_load div#preloader {
            position: fixed;
            left: 0;
            top: 4em;
            z-index: 999;
            width: 100%;
            height: 100%;
            overflow: visible;
            background: #ffffff url('https://www.createwebsite.net/wp-content/uploads/2015/09/GD.gif') no-repeat center center;
        }

        #location_form_loader {
            background: #ffffff url('https://epay.khcbonline.net/regportal/images/Preloader_1.gif') no-repeat center center;
            width: 100%;
            height: 8em;
            position: absolute;
            z-index: 999;
            margin-left: -2em;
            display: none;
        }

        #overlay {
            background: #ffffff;
            color: #666666;
            position: fixed;
            height: 100%;
            width: 100%;
            z-index: 5000;
            top: 0;
            left: 0;
            float: left;
            text-align: center;
            padding-top: 25%;
        }


    </style>


{% endblock %}

{% block title %}
    Ajout Competétition
{% endblock %}



{% block body %}

    <div class="to_load">
        <div id="preloader"></div>

        <!-- Form add competition -->
        <h1>Ajouter une compétition</h1>

        <!-- Form name -->
        <div class="form-group">
            <label>Nom</label>
            <input type="text" class="form-control competitionName">
        </div>
        <hr>

        <!-- Form date -->
        <label>Date</label>
        <div class="row">
            <div class="form-group col-lg-offset-1 col-sm-4">
                <label>Du</label>
                <input class="form-control datepicker dpStart">
            </div>

            <div class="form-group col-lg-offset-1 col-sm-4">
                <label>Au</label>
                <input class="form-control datepicker dpEnd">
            </div>
        </div>
        <hr>

        <!-- Form location -->
        <label>Adresse</label>
        <div id="location_form" class="row">

            <div id="location_form_alert" class="alert alert-warning" role="alert"></div>

            <!-- Input data -->
            <div class="location_form_input col-xs-offset-1 col-xs-6">
                <div id="location_form_loader"></div>

                <div class="dep_form row">
                    <div id="dep_form_edit" class="form_edit">
                        <label>Département</label>
                        <input id="dep_input" class="typeahead col-xs-5" type="text"
                               placeholder="ex : 29 Finistère">
                        <button class="col-xs-2 next_step btn btn-primary btn-sm" value="dep"
                                onclick="nextStep('depValidate')">Suivant
                        </button>
                    </div>
                </div>

                <div class="city_form row">
                    <div id="city_form_edit" class="form_edit">
                        <label>Villes</label>
                        <input id="city_input" class="typeahead col-xs-5" type="text" placeholder="ex : rennes">
                        <button class="col-xs-2 next_step btn btn-primary btn-sm" value="city"
                                onclick="nextStep('cityValidate')">Suivant
                        </button>
                    </div>

                </div>

                <div class="address_form row">
                    <div id="address_form_edit" class="form_edit">

                        <div class="form-group">
                            <label>Nom</label>
                            <input type="text" class="form-control competitionName">
                        </div>

                        <!--
                        <div><label>Adresse</label></div>
                        <input id="address_input" class="typeahead col-xs-10" type="text"
                               placeholder="ex : 28 rue Lulu">
                        <button class=" col-xs-2 next_step btn btn-primary btn-sm" value="address"
                                onclick="nextStep('addressValidate')">Suivant
                        </button>
                        -->
                    </div>

                </div>
            </div>
            <!-- Show data -->
            <div class="col-xs-5">
                <div class="row">
                    <div id="dep_form_show" class="form_show row">
                        <p id="dep_show" class="col-xs-7"></p>
                        <button class="col-xs-2 edit_bt btn btn-success btn-xs" onclick="returnStep('dep')">Modifier
                        </button>
                    </div>
                    <div id="city_form_show" class="form_show row">
                        <p id="city_show" class="col-xs-7"></p>
                        <button class="col-xs-2  edit_bt btn btn-success btn-xs" onclick="returnStep('depValidate')">
                            Modifier
                        </button>
                    </div>
                    <div id="address_form_show" class="form_show row">
                        <p id="address_show" class="col-xs-7"></p>
                        <button class="col-xs-2 edit_bt btn btn-success btn-xs" onclick="returnStep('cityValidate')">
                            Modifier
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End form add competition -->

        <div id="mapid"></div>
    </div>

    <button id="fade">fade</button>


{% endblock %}

    {% block javascripts %}
        {{ parent() }}

        <script>
            $("#fade").click(function () {
                $('#location_form_loader').fadeOut();
            });
        </script>

        <! address typeahead********************************************************************************************>
        <script src="{{ asset('js/jqueryui.min.js') }}"></script>
        <script src="{{ asset('js/typeahead.bundle.js') }}"></script>
        <script>
            var formsEdit = $(".form_edit");
            var formsShow = $(".form_show");

            var depFormEdit = $("#dep_form_edit");
            var depFormShow = $("#dep_form_show");
            var depInput = $("#dep_input");
            var depShow = $("#dep_show");

            var cityFormEdit = $("#city_form_edit");
            var cityFormShow = $("#city_form_show");
            var cityInput = $("#city_input");
            var cityShow = $("#city_show");

            var addressFormEdit = $("#address_form_edit");
            var addressFormShow = $("#address_form_show");
            var addressInput = $("#address_input");
            var addressShow = $("#address_show");

            var autocompleteAddressList;
            var cityCode;


            var alert = $("#location_form_alert");

            var substringMatcher = function (strs) {
                return function findMatches(q, cb) {
                    var matches, substringRegex;

                    // an array that will be populated with substring matches
                    matches = [];

                    // regex used to determine if a string contains the substring `q`
                    substrRegex = new RegExp(q, 'i');

                    // iterate through the pool of strings and for any string that
                    // contains the substring `q`, add it to the `matches` array
                    $.each(strs, function (i, str) {
                        if (substrRegex.test(str)) {
                            matches.push(str);
                        }
                    });

                    cb(matches);
                };
            };

            //Dep**************************************************************
            function depValidate() {
                var dep = depInput.val().slice(0, 2);

                $.get("{{ asset('json/departements3.json') }}", function (data, status) {
                    if (jQuery.inArray(dep, data) !== -1) {
                        cityAutocomplete(dep);
                        nextStep('city');
                        alert.hide();
                    } else {
                        nextStep('dep');
                        alert.text('Veuillez sélectionner un département dans la liste');
                        alert.show();
                    }
                });
            }

            function depAutocomplete() {
                $.get("{{ asset('json/departements2.json') }}", function (data, status) {

                    depInput.typeahead(null, {
                        name: 'departement',
                        limit: 20,
                        source: substringMatcher(data)
                    });
                });
            }

            //City*************************************************************
            function cityValidate() {
                var citySlug = cityInput.val();
                $.ajax({
                    url: "{{ path('address_getCitiesData') }}",
                    data: {ville_slug: citySlug},
                    dataType: "json",
                    success: function (data) {

                        var cityData = data[0];

                        if (data.length > 0 && citySlug == cityData.villeSlug) {

                            cityCode = cityData.villeCodeCommune;
                            cityShow.text(cityData.villeNomReel);
                            alert.hide();

                            addressAutocomplete(cityData.villeCodeCommune);
                            nextStep('address');

                        } else {
                            alert.text('Veuillez sélectionner une ville dans la liste');
                            alert.show;
                            nextStep('city');
                        }
                    }
                });
            }

            function cityAutocomplete(dep) {
                $.ajax({
                    url: "{{ path('address_getCitiesSlugByDep') }}",
                    data: {dep: dep},
                    dataType: "json",
                    success: function (data) {
                        var cities = new Array();
                        $.each(data, function (index, city) {
                            cities.push(city.villeSlug)
                        })

                        cityInput.typeahead(null, {
                            name: 'villes',
                            limit: 20,
                            source: substringMatcher(cities)
                        });
                    }
                });
            }

            //Address**********************************************************
            function addressAutocomplete(cityCode) {
                addressInput.autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: "https://api-adresse.data.gouv.fr/search/?citycode=" + cityCode,
                            data: {q: request.term},
                            dataType: "json",
                            success: function (data) {
                                response($.map(data.features, function (item) {
                                    return {label: item.properties.name, value: item.properties.name};
                                }));
                                autocompleteAddressList = data.features;
                            }
                        });
                    }
                });
            }

            function addressValidate() {
                $.ajax({
                    url: "https://api-adresse.data.gouv.fr/search/?q=rennes",
                    data: {q: addressInput.val()},
                    dataType: "json",
                    success: function (data) {
                        if (data.features.length > 0 && data.features[0].properties.name == addressInput.val()) {
                            nextStep('confirm');
                            alert.text('');
                        } else {
                            alert.text('Veuillez sélectionner une adresse dans la liste');
                            alert.hide();
                            nextStep('address');
                        }
                    }
                });
            }

            //Confirm**********************************************************
            var localizationData;

            function getCityData() {
                var address = $('#address_input').val();

                $.ajax({
                    url: "https://api-adresse.data.gouv.fr/search/?citycode=" + cityCode,
                    data: {q: address},
                    dataType: "json",
                    success: function (data) {
                        var f = data.features[0];
                        localizationData = {
                            id: f.properties.id,
                            street: f.properties.name,
                            postCode: f.properties.postcode,
                            city: f.properties.city,
                            x: f.geometry.coordinates[1],
                            y: f.geometry.coordinates[0]
                        }

                        openMap(localizationData.x, localizationData.y);
                        locationFlush(localizationData);
                    }
                });
            }

        </script>

        <! datepicker***************************************************************************************************>
        <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.0/js/bootstrap-datepicker.min.js"></script>
        <script src="{{ asset('datepicker/datepicker-fr.js') }}"></script>
        <script>
            $('.datepicker').datepicker({
                language: 'fr',
                format: 'dd-mm-yyyy',
                todayBtn: 'linked',
                autoclose: true,
                todayHighlight: true
            });

            $('.dpStart').on('changeDate', function () {
                var startDate = $('.dpStart').datepicker('getDate');
                $('.dpEnd').datepicker(
                    'setStartDate', startDate
                );
            });
        </script>

        <! map leaflet**************************************************************************************************>
        <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
                integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
                crossorigin=""></script>

        <script>
            function openMap(x, y) {
                var mymap = L.map('mapid').setView([x, y], 25);

                var marker = L.marker([x, y]).addTo(mymap);

                L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(mymap);
            }

            var map = $('#mapid');
        </script>

        <! this page step***********************************************************************************************>
        <script>
            $(document).ready(function () {
                formsEdit.hide();
                formsShow.hide();
                alert.hide();
                nextStep('dep');
                $(window).load(function () {
                    $('#preloader').fadeOut('slow', function () {
                        $(this).remove();
                    });
                });
            });

            function nextStep(step) {
                formsEdit.hide();

                switch (step) {

                    case 'dep' :
                        depFormEdit.show();
                        depAutocomplete();
                        break;

                    case 'depValidate' :
                        depValidate();
                        $('#location_form_loader').show();
                        break;

                    case 'city' :
                        depShow.text(depInput.val());
                        cityFormEdit.show();
                        depFormShow.show();
                        $('#location_form_loader').delay(1500).fadeOut(2000);
                        break;

                    case 'cityValidate' :
                        cityValidate();
                        $('#location_form_loader').show();
                        break;

                    case 'address' :
                        cityFormShow.show();
                        addressFormEdit.show();
                        $('#location_form_loader').delay(1500).fadeOut(2000);
                        break;

                    case 'addressValidate' :
                        addressValidate();
                        break;

                    case 'confirm' :
                        addressShow.text(addressInput.val());
                        addressFormShow.show();
                        getCityData();
                        break;
                }
            }

            function returnStep(step) {
                switch (step) {
                    case 'dep' :
                        depInput.typeahead("destroy");
                        depInput.val('');
                        depFormShow.hide();

                    case  'depValidate' :
                        cityInput.typeahead("destroy");
                        cityInput.val('')
                        cityFormShow.hide();

                    case  'cityValidate' :
                        addressInput.val('');
                        addressFormShow.hide();
                        map.hide();
                }
                nextStep(step);
            }


            function locationFlush(locationData) {
                var competition = {
                    name: $('.competitionName').val(),
                    dateStart: $('.dpStart').val(),
                    dateEnd: $('.dpEnd').val(),
                };

                var data = {
                    competition: competition,
                    location: locationData
                }

                $.ajax({
                    url: "{{ path('location_new') }}",
                    data: {
                        location: data
                    },
                    dataType: "json",
                    success: function (response) {
                        console.log(response);
                    }
                });


            }

        </script>

    {% endblock %}

