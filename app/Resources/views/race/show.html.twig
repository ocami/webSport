{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        .panel span {
            display: block;
            text-align: center;
            font-size: larger;
        }

        .race-organizer {
            margin-bottom: 2em;
        }

        .btn-category {
            padding: 1em;
            height: 2em;
        }

        .race-distance {
            text-align: center;
            font-size: 20px;
            font-weight: bolder;
            margin-top: 2em;
            margin-bottom: 2em;
        }
    </style>

{% endblock %}

{% block title %}
    {{ parent() }} {{ race.name }}
{% endblock %}

{% block organizer_menu %}
    {% if race.isOrganizer == true %}
        {% if race.enrol == true %}
            <input type="button" class="btn-xs btn-success" value="Clore les inscriptions"
                   onclick="location.href = '{{ path('race_enrol_closed', {'id':race.id} ) }}';">

            <input type="button" class="btn-xs btn-success" value="Simuler inscription"
                   onclick="location.href = '{{ path('race_simulateEnrol', {'id':race.id} ) }}';">
        {% endif %}

        {% if race.enrol == false %}
            <input type="button" class="btn-xs btn-success" value="Importer les temps de courses"
                   onclick="location.href = '{{ path('race_competitorsTimes', {'id':race.id} ) }}';">
        {% endif %}
    {% endif %}
{% endblock %}

{% block body %}


    {% block show_race %}

        <div class="race-show row">
            <h2 style="text-align: center"><span class="competition">{{ race.competition.name }}</span> / <span
                        class="race_name">{{ race.name }}</span></h2>

            <div class="race-organizer">Organisateur : <span
                        class="organizer">{{ race.competition.organizer.name }}</span>
            </div>


            <div class="col-xs-12 col-md-5">
                <div class=" col-xs-offset-1 col-xs-10">
                    <div class="panel panel-primary">
                        <div class="panel-heading "><span class="glyphicon glyphicon-time"></span></div>
                        <div class="panel-body">
                            <span class="date-day">{{ race.dateTime|localizeddate('none', 'none', 'fr_BR', null, "cccc d MMMM") }}</span>
                            <span class="date-hour">{{ race.dateTime|date('H') }} H {{ race.dateTime|date('i') }}</span>


                        </div>
                    </div>
                </div>
                <div class=" col-xs-offset-1 col-xs-10">
                    <div class="panel panel-primary ">
                        <div class="panel-heading"><span class="glyphicon glyphicon-map-marker"></span></div>
                        <div class="panel-body race-location">
                            <span>{{ race.competition.location.street }}</span>
                            <span>{{ race.competition.location.postCode }}  {{ race.competition.location.city }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xs-12 col-md-7">

                <div class="col-xs-12 race-distance">{{ race.distance }} KM</div>

                <div class="row">
                    {% for c in race.categories %}
                        <div class="btn-category col-xs-6 col-lg-4">
                            <button
                                    class="btn-xs btn-info col-xs-12"
                                    onclick="requestForTableCategory({{ race.id }}, {{ c.id }}, '{{ c.name }}')">{{ c.name }}
                            </button>
                        </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    {% endblock %}


    <button class="btn-xs btn-primary row" onclick="requestForTableGeneral({{ race.id }})">Classement général</button>


    <!----------------------------------------------------------------------------------------------------------------->


    {% block ranck_race %}


        <br><br>

        <h1 id="category"></h1>

        <div id="loader"></div>

        <div id="tables">
            {% if race.inChampionship == true %}
                <div id="buttons"></div>
            {% endif %}

            <div id="tableRace">
                <div id="table-race-container">
                    <table id="table-race" cellspacing="0" width="100%">
                        <thead>
                        <tr class="row-table-race">
                        </tr>
                        </thead>
                    </table>
                </div>

                <div id="table-race-category-container">

                    <table id="table-race-category" cellspacing="0" width="100%">
                        <thead>
                        <tr class="row-table-race-category">
                        </tr>
                        </thead>
                    </table>
                </div>


            </div>

            <div id="tableChampionship">
                <table id="dataTableChampionship" cellspacing="0" width="100%">
                    <thead>
                    <tr>
                        <th>Classement</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Points</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    {% endblock %}



{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        $(document).ready(function () {
            requestForTableGeneral({{ race.id }});
            $('#tables').css('display', 'none');
            $('#loader').css('display', 'block');
        });

        function requestForTableGeneral(idRace) {
            var request = {idRace: idRace, category: 'all'};
            getRaceTable(request, 'all');
            load(true);
            etat('general');
        }

        function requestForTableCategory(idRace, idCategory, nameCategory) {
            var request = {idRace: idRace, category: idCategory};
            getRaceTable(request, idCategory);
            load(true);
            etat('general');
        }

        function requestForTableChampionship(idRace, idCategory, nameCategory) {
            var path = "{{ path('championship_json') }}";
            var request = {idCategory: idCategory};
            getRaceTableChampionship(path, request);
            $('#buttons').children("button").remove();
            $('#buttons').append("<button id=\"raceButton\" onclick=\"requestForTableCategory(" + idRace + ", " + idCategory + ",' " + nameCategory + " ')\">Course</button>");
            load(true);
            etat('championship');
        }

        function getRaceTable(request, category) {
            $.ajax({
                url: "{{ path('race_Table') }}",
                data: request,
                success: function (result) {
                    displayTable(result, category);
                }
            });
        }

        function displayTable(data, category) {
            console.log(category);

            var rowTable = $('.row-table-race')
            var language = {
                "search": "Rechercher:",
                "lengthMenu": "Voir _MENU_ compétiteurs  par page",
                "zeroRecords": "Aucune inscription",
                "paginate": {
                    "first": "Premier",
                    "last": "Dernier",
                    "next": "Suivant",
                    "previous": "précédent"
                }
            };
            var options;
            var option2 = {
                "info": false,
                "language": {
                    "search": "Rechercher:",
                    "lengthMenu": "Voir _MENU_ courses  par page",
                    "zeroRecords": "Aucune courses non traitées",
                    "paginate": {
                        "first": "Premier",
                        "last": "Dernier",
                        "next": "Suivant",
                        "previous": "précédent"
                    },
                },

                columns: [
                    {data: 'checkbox'},
                    {data: 'id'},
                    {data: 'name'},
                    {data: 'organizer'},
                    {data: 'city'},
                    {data: 'date'},
                    {data: 'championship'}
                ],
                columnDefs: [
                    {
                        targets: 0,
                        orderable: false,
                        className: 'select-checkbox',
                        width: "5%"
                    },
                    {
                        targets: 1,
                        visible: false
                    },
                    {
                        targets: 5,
                        width: "20%"
                    },
                    {
                        targets: 6,
                        width: "5%"
                    }
                ]
            };


            if (category === 'all') {
                switch (data.race_state) {
                    case 0:
                        raceOpenOptions();
                        break;

                    case 1:
                        raceCloseOptions();
                        break;

                    case 2:
                        racePassedOptions();
                        break;
                }
                $('#table-race-category-container').hide();
                $('#table-race-container').show();
                $('#table-race').dataTable(options);
            } else {
                switch (data.race_state) {
                    case 0:
                        raceCategoryOpenOptions();
                        break;

                    case 1:
                        raceCategoryCloseOptions();
                        break;

                    case 2:
                        raceCategoryPassedOptions();
                        break;
                }
                $('#table-race-container').hide();
                $('#table-race-category-container').show();
                $('#table-race-category').empty();
                $('#table-race-category').dataTable(options);
            }


            load(false);

            function raceOpenOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    columns: [
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'category'}
                    ]
                };
                rowTable.empty();

                rowTable.append("<th>Nom</th>");
                rowTable.append("<th>Prénom</th>");
                rowTable.append("<th>Catégorie</th>")
            }

            function raceCloseOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    columns: [
                        {data: 'number'},
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'category'}
                    ]
                };
                rowTable.empty();
                rowTable.append("<th>Dossard</th>");
                rowTable.append("<th>Nom</th>");
                rowTable.append("<th>Prénom</th>");
                rowTable.append("<th>Catégorie</th>")
            }

            function racePassedOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    order: [[0, "asc"]],
                    columns: [
                        {data: 'ranck'},
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'category'},
                        {data: 'chronoString'},
                        {data: 'ranckCategory'},
                        {data: 'points'},
                    ]
                };

                rowTable.empty();
                $('.row-table-race').append("<th>Gen.</th>");
                $('.row-table-race').append("<th>Nom</th>");
                $('.row-table-race').append("<th>Prénom</th>");
                $('.row-table-race').append("<th>Catégorie</th>");
                $('.row-table-race').append("<th>Chrono</th>");
                $('.row-table-race').append("<th>Classement</th>");
                $('.row-table-race').append("<th>Point</th>");
            }

            function raceCategoryOpenOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    columns: [
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'category'}
                    ]
                };
                rowTable.empty();

                rowTable.append("<th>Nom</th>");
                rowTable.append("<th>Prénom</th>");
                rowTable.append("<th>Catégorie</th>")
            }

            function raceCategoryCloseOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    columns: [
                        {data: 'number'},
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'category'}
                    ]
                };
                rowTable.empty();
                rowTable.append("<th>Dossard</th>");
                rowTable.append("<th>Nom</th>");
                rowTable.append("<th>Prénom</th>");
                rowTable.append("<th>Catégorie</th>")
            }

            function raceCategoryPassedOptions() {
                options = {
                    destroy: true,
                    data: data.competitors,
                    language: language,
                    order: [[0, "asc"]],
                    columns: [
                        {data: 'ranckCategory'},
                        {data: 'ranck'},
                        {data: 'lastName'},
                        {data: 'firstName'},
                        {data: 'chronoString'},
                        {data: 'points'},
                        {data: 'number'}
                    ]

                };

                rowTable.empty();
                $('#table-race-category').append("<th></th>");
                $('#table-race-category').append("<th>Nom</th>");
                $('#table-race-category').append("<th>Prénom</th>");
                $('#table-race-category').append("<th>Chrono</th>");
                $('#table-race-category').append("<th>Gen.</th>");
                $('#table-race-category').append("<th>Point</th>");
                $('#table-race-category').append("<th>Doss.</th>");
            }
        }

        function getRaceTableChampionship(path, request) {
            $.ajax({
                url: path,
                data: request,
                success: function (result) {
                    $('#dataTableChampionship').dataTable({
                        destroy: true,
                        data: result,
                        order: [[3, "dsc"]],
                        columns: [
                            {data: 'ranck'},
                            {data: 'lastName'},
                            {data: 'firstName'},
                            {data: 'points'}]
                    });

                    load(false);
                }
            });
        }

        function etat(stat) {
            switch (stat) {
                case 'category':
                    $('#championshipButton').css('display', 'block');
                    $('#raceButton').css('display', 'none');
                    $('#tableRace').css('display', 'block');
                    $('#tableChampionship').css('display', 'none');
                    break;
                case 'championship':
                    $('#championshipButton').css('display', 'none');
                    $('#raceButton').css('display', 'block');
                    $('#tableRace').css('display', 'none');
                    $('#tableChampionship').css('display', 'block');
                    break;
                case 'general':
                    $('#championshipButton').css('display', 'none');
                    $('#raceButton').css('display', 'none');
                    $('#tableRace').css('display', 'block');
                    $('#tableChampionship').css('display', 'none');
                    $('#category').text("Classement général");
                    break;
                default:
                    $('#championshipButton').css('display', 'none');
                    $('#raceButton').css('display', 'none');
                    $('#tableRace').css('display', 'block');
                    $('#tableChampionship').css('display', 'none');
                    alert('category');
            }
        }

        function load(stat) {
            switch (stat) {
                case true:
                    $('#tables').css('display', 'none');
                    $('#loader').css('display', 'block');
                    ;
                    break;
                case false:
                    $('#tables').css('display', 'block');
                    $('#loader').css('display', 'none');
                    break;
                default:
                    $('#tables').css('display', 'block');
                    $('#loader').css('display', 'none');
            }
        }


    </script>

{% endblock %}
