{% extends 'base.html.twig' %}

{% block title %}
    {{ parent() }} index
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <link rel="stylesheet" href="{{ asset('tools/tools.css') }}"/>

    <style>

        #index-map {
           height: 90%;
        }

        #small-map {
            height: 12em;
        }

        #index-map-container{
            height: 75vh;
            background-color: #ffffff;
            position: absolute;
        }

        .leaflet-popup-img {
            height: 3em;
        }

    </style>
{% endblock %}

{% block body %}

    <div class="col-md-3">
        <div id="loader-div"></div>
        <div id="small-map-container" class="col-xs-12">
            <div class="col-xs-12" id="small-map"></div>
        </div>
        <button type="button" id="button-map" value="not-initialized" class="btn btn-info btn-sm col-xs-12">Agrandir</button>
    </div>
    <div class="col-md-6"></div>
    <div class="col-md-3"></div>

    <div id="index-map-container" class="col-xs-10">
        <div class="col-xs-12" id="index-map"></div>
        <br>
        <button type="button" id="button-map-close" class="btn btn-info btn-sm pull-right">Fermer</button>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script>

        var $smallMap = $('#small-map');
        var $smallMapContainer = $('#small-map-container');
        var $indexMap = $('#index-map');
        var $indexMapConatiner = $('#index-map-container');
        var $indexButton = $('#button-map');
        var dataMap;

        $(function () {

            //loaderDivStart($smallMap);
            $indexMapConatiner.hide();

            //data map
            var path = Routing.generate('competition_get_geojson');
            $.ajax({
                url: path,
                success: function (data) {
                    dataMap = data;
                    smallMapBuild(data);
                },
                error: function () {
                    ajaxError();
                }
            });
        });

        // Event**************************************************************************************************>

        $indexButton.click(function () {
            $smallMapContainer.hide();
            $indexMapConatiner.show();
            if($(this).val() === 'not-initialized'){
                indexMapBuild(dataMap);
                $(this).val('is-initialized');
            }
        });

        $('#button-map-close').click(function () {
            $indexMapConatiner.hide();
            $smallMapContainer.show();
        });

        // Maps build**************************************************************************************************>
        var pastIcon = L.icon({
            iconUrl: 'http://icons.iconarchive.com/icons/icons-land/vista-map-markers/256/Map-Marker-Marker-Outside-Pink-icon.png',
            iconSize: [30, 30],
            iconAnchor: [11, 31],
            popupAnchor: [5, -25],

        });
        var futureIcon = L.icon({
            iconUrl: 'http://www.iconarchive.com/download/i57834/icons-land/vista-map-markers/Map-Marker-Marker-Outside-Chartreuse.ico',
            iconSize: [30, 30],
            iconAnchor: [11, 31],
            popupAnchor: [5, -25],

        });

        function smallMapBuild(data) {
            var FuturCompetitionLayer = layerBuild(data.futureCompetitions, pastIcon);

            var osmLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var smallMap = L.map('small-map', {
                center: [46.52863469527167, 2.43896484375],
                zoom: 4,
                layers: [osmLayer, FuturCompetitionLayer]
            });

            //loaderDivStop($smallMap);
        }

        function indexMapBuild(data) {
            var watercolorLayer = L.tileLayer('http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var FuturCompetitionLayer2 = layerBuild(data.futureCompetitions, pastIcon);
            var PastCompetitionLayer2 = layerBuild(data.pastCompetitions, futureIcon);

            var osmLayer2 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var indexMap = L.map('index-map', {
                center: [46.52863469527167, 2.43896484375],
                zoom: 5,
                layers: [osmLayer2, PastCompetitionLayer2, FuturCompetitionLayer2]
            });

            //Layers Control **************************************************************************************************>
            var baseMaps = {
                "osmLayer": osmLayer2,
                "watercolorLayer": watercolorLayer
            };
            var overlayMaps = {
                "A venir": FuturCompetitionLayer2,
                "Pass√©es": PastCompetitionLayer2
            };

            L.control.layers(baseMaps, overlayMaps).addTo(indexMap);
        }

        function layerBuild(data, icon) {
            return L.geoJSON(data, {
                pointToLayer: function (geoJsonPoint, latlng) {
                    return L.marker(latlng, {icon: icon});
                }
            }).bindPopup(function (layer) {
                return layer.feature.properties.description;
            });
        }
    </script>

{% endblock %}

