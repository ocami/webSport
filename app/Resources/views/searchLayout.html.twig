{% extends 'form_layout.html.twig' %}

{% block title %}
    {{ parent() }} index
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretty-checkbox@3.0/dist/pretty-checkbox.min.css"/>
    <link rel="stylesheet" href="{{ asset('css/multi-switch.min.css') }}"/>
    <link rel="stylesheet" href="{{ asset('css/jquery.mCustomScrollbar.min.css') }}"/>

    <style>
        #search-bar {
            margin-top: 16em;
        }

        #index-map {
            height: 90%;
        }

        #small-map-container {
            height: 13em;
        }

        #small-map {
            height: 12em;
        }

        #index-map-container {
            height: 85vh;

        }

        .leaflet-popup-img {
            height: 3em;
        }

        #button-map {
            visibility: hidden;
        }

        #index-container {
            margin-left: 16em;
            padding-right: 0em;
        }

        #left-container {
            height: 100%;
            width: 18em;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 4em;
            padding-left: 0.5em;
        }

    </style>
{% endblock %}

{% block body %}

    <div id="left-container">


        <div id="small-map-container" class="col-xs-12">
            <div class="col-xs-12" id="small-map"></div>
            <button type="button" id="button-map" value="not-initialized" class="btn btn-info btn-sm col-xs-12">
                Agrandir
            </button>
        </div>

        {% include 'race/widget/searchBar.html.twig' %}


    </div>


    <div id="index-container">
        <div id="index-content">
            {% block search_content %}
            {% endblock %}
        </div>

        <div id="index-map-container" class="col-xs-offset-1 col-xs-10">
            <div class="col-xs-12" id="index-map"></div>
            <br>
            <button type="button" id="button-map-close" class="btn btn-info btn-sm pull-right">Fermer</button>
        </div>
    </div>
{% endblock %}


{% block javascripts %}
    {{ parent() }}

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script src="{{ asset('js/jquery.mCustomScrollbar.concat.min.js') }}"></script>

    <script>
        //init
        //indexMaps();
        searchBarRace();
        panelCategoriesScroll();


        var $indexContent = $('#index-content');
        var $smallMap = $('#small-map');
        var $smallMapContainer = $('#small-map-container');
        var $indexMap = $('#index-map');
        var $indexMapConatiner = $('#index-map-container');
        var $btMap = $('#button-map');
        var dataMap;
        var pastIcon = L.icon({
            iconUrl: '/webSport/web/img/green.ico',
            iconSize: [30, 30],
            iconAnchor: [11, 31],
            popupAnchor: [5, -25]
        });
        var futureIcon = L.icon({
            iconUrl: '/webSport/web/img/pink.png',
            iconSize: [30, 30],
            iconAnchor: [11, 31],
            popupAnchor: [5, -25]
        });

        //init
        $indexMapConatiner.hide();
        initialiseMap();

        // Event**************************************************************************************************>

        $btMap.click(function () {
            $indexContent.hide();
            $indexMapConatiner.show();
            if ($(this).val() === 'not-initialized') {
                indexMapBuild(dataMap);
                $(this).val('is-initialized');
            }
        });

        $('#button-map-close').click(function () {
            $indexMapConatiner.hide();
            $indexContent.show();
        });

        // Functions**************************************************************************************************>
        function initialiseMap() {
            var path = Routing.generate('competition_get_geojson');
            $.ajax({
                url: path,
                success: function (data) {
                    dataMap = data;
                    smallMapBuild(data);
                },
                error: function () {
                    ajaxError();
                }
            });
        }

        function smallMapBuild(data) {
            var FuturCompetitionLayer = layerBuild(data.futureCompetitions, pastIcon);

            var osmLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var smallMap = L.map('small-map', {
                center: [46.52863469527167, 0],
                zoom: 4,
                layers: [osmLayer, FuturCompetitionLayer]
            });

            $btMap.css('visibility', 'visible');
        }

        function indexMapBuild(data) {
            var watercolorLayer = L.tileLayer('http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var FuturCompetitionLayer2 = layerBuild(data.futureCompetitions, pastIcon);
            var PastCompetitionLayer2 = layerBuild(data.pastCompetitions, futureIcon);

            var osmLayer2 = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 18
            });
            var indexMap = L.map('index-map', {
                center: [46.52863469527167, 2.43896484375],
                zoom: 5,
                layers: [osmLayer2, PastCompetitionLayer2, FuturCompetitionLayer2]
            });

            //Layers Control **************************************************************************************************>
            var baseMaps = {
                "osmLayer": osmLayer2,
                "watercolorLayer": watercolorLayer
            };
            var overlayMaps = {
                "A venir": FuturCompetitionLayer2,
                "Pass√©es": PastCompetitionLayer2
            };

            L.control.layers(baseMaps, overlayMaps).addTo(indexMap);
        }

        function layerBuild(data, icon) {
            return L.geoJSON(data, {
                pointToLayer: function (geoJsonPoint, latlng) {
                    return L.marker(latlng, {icon: icon});
                }
            }).bindPopup(function (layer) {
                return layer.feature.properties.description;
            });
        }

    </script>

{% endblock %}

